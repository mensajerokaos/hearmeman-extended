version: '3.8'

services:
  # ===========================================
  # XTTS v2 Voice Cloning Server (API + UI)
  # Web UI: http://localhost:8020/docs (Swagger)
  # API: http://localhost:8020/tts_to_audio
  # ===========================================
  xtts:
    image: daswer123/xtts-api-server:latest
    container_name: xtts
    runtime: nvidia
    ports:
      - "8020:8020"
    environment:
      - DEVICE=cuda
    volumes:
      - ./xtts-models:/root/.cache/huggingface
      - ./xtts-speakers:/root/speakers
      - ./output:/root/output
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    profiles:
      - xtts  # Only starts with: docker compose --profile xtts up

  # ===========================================
  # Chatterbox TTS (Resemble AI)
  # API: http://localhost:8000/health
  # OpenAI-compatible: http://localhost:8000/v1/audio/speech
  # ===========================================
  chatterbox:
    build:
      context: ./chatterbox-api
      dockerfile: docker/Dockerfile.gpu
    image: chatterbox-tts-api:local
    container_name: chatterbox
    runtime: nvidia
    ports:
      - "8000:4123"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ./chatterbox-voices:/app/voices
      - ./output:/app/output
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    profiles:
      - chatterbox  # Only starts with: docker compose --profile chatterbox up

  # ===========================================
  # ComfyUI Main Service
  # ComfyUI: http://localhost:8188
  # TTS profiles: xtts, chatterbox
  # ===========================================
  hearmeman-extended:
    build:
      context: .
      dockerfile: Dockerfile
    image: hearmeman-extended:local
    container_name: hearmeman-extended
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - ENABLE_VIBEVOICE=true
      - ENABLE_CONTROLNET=true
      - ENABLE_ILLUSTRIOUS=false
      - ENABLE_ZIMAGE=false
      - VIBEVOICE_MODEL=Large
      - STORAGE_MODE=persistent
      - COMFYUI_PORT=8188
    ports:
      - "8188:8188"
      - "8888:8888"
      - "2222:22"
    volumes:
      - ./models:/workspace/ComfyUI/models
      - ./output:/workspace/ComfyUI/output
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

volumes:
  models:
  output:
  xtts-models:
  xtts-speakers:
