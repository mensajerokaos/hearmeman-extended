services:
  # ===========================================
  # PostgreSQL - Media Analysis Database
  # Independent database for media analysis service
  # ===========================================
  media-pg-1:
    image: postgres:16-alpine
    container_name: media-pg-1
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres_admin_pwd_2026
      POSTGRES_DB: media_analysis
    ports:
      - "5433:5432"  # Use 5433 to avoid conflict with any existing postgres
    volumes:
      - media-pg-data:/var/lib/postgresql/data
      - ./init-media-db.sql:/docker-entrypoint-initdb.d/01-init-media-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d media_analysis"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    profiles:
      - database  # Start with: docker compose --profile database up -d

  # ===========================================
  # Media Analysis API
  # FastAPI service for media analysis
  # ===========================================
  media-analysis-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    image: media-analysis-api:local
    container_name: media-analysis-api
    environment:
      # Database configuration (uses media_analysis by default)
      - MEDIA_DB_HOST=media-pg-1
      - MEDIA_DB_PORT=5432
      - MEDIA_DB_NAME=media_analysis
      - MEDIA_DB_USER=media_analysis_user
      - MEDIA_DB_PASSWORD=media_analysis_secure_pwd_2026
      # Pool settings
      - DB_POOL_MIN=5
      - DB_POOL_MAX=20
      - DB_POOL_OVERFLOW=10
      # Logging
      - LOG_LEVEL=INFO
    ports:
      - "8080:8080"
    depends_on:
      media-pg-1:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - api  # Start with: docker compose --profile api up -d

  # ===========================================
  # Chatterbox TTS (Resemble AI)
  # API: http://localhost:8000/health
  # OpenAI-compatible: http://localhost:8000/v1/audio/speech
  # ===========================================
  chatterbox:
    build:
      context: ./chatterbox-api
      dockerfile: docker/Dockerfile.gpu
    image: chatterbox-tts-api:local
    container_name: chatterbox
    runtime: nvidia
    ports:
      - "8000:4123"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ./chatterbox-voices:/app/voices
      - ./output:/app/output
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    profiles:
      - chatterbox  # Only starts with: docker compose --profile chatterbox up

  # ===========================================
  # ComfyUI Main Service
  # ComfyUI: http://localhost:8188
  # TTS profile: chatterbox
  # ===========================================
  hearmeman-extended:
    build:
      context: .
      dockerfile: Dockerfile
    image: hearmeman-extended:local
    container_name: hearmeman-extended
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      # Existing models
      - ENABLE_VIBEVOICE=true
      - ENABLE_CONTROLNET=true
      - ENABLE_ILLUSTRIOUS=false
      - ENABLE_ZIMAGE=false
      - VIBEVOICE_MODEL=Large
      - STORAGE_MODE=persistent
      - COMFYUI_PORT=8188
      # GPU Configuration (auto-detect or manual override)
      - GPU_TIER=consumer
      - GPU_MEMORY_MODE=auto
      # Tier 1: Consumer GPU (8-24GB VRAM)
      - ENABLE_GENFOCUS=true
      - ENABLE_QWEN_EDIT=true
      - QWEN_EDIT_MODEL=Q4_K_M
      # Options: Q4_K_M (13GB), Q5_K_M (15GB), Q8_0 (22GB), full (54GB)
      - ENABLE_MVINVERSE=true
      # Tier 2: Prosumer GPU (24GB+ with CPU offload)
      - ENABLE_FLASHPORTRAIT=false
      - ENABLE_STORYMEM=false
      # Tier 3: Datacenter GPU (48-80GB A100/H100)
      - ENABLE_INFCAM=false

      # SteadyDancer (Dance Video Generation)
      - ENABLE_STEADYDANCER=false
      - STEADYDANCER_VARIANT=fp8
      - STEADYDANCER_GUIDE_SCALE=5.0
      - STEADYDANCER_CONDITION_GUIDE=1.0
      - STEADYDANCER_END_CFG=0.4
      - STEADYDANCER_SEED=106060

      # DWPose (Pose Extraction for Dance Video)
      - ENABLE_DWPOSE=false
      - DWPOSE_DETECT_HAND=true
      - DWPOSE_DETECT_BODY=true
      - DWPOSE_DETECT_FACE=true
      - DWPOSE_RESOLUTION=512

      # TurboDiffusion (100-200x acceleration for video generation)
      - ENABLE_WAN22_DISTILL=false
      - TURBO_STEPS=4
      - TURBO_GUIDE_SCALE=5.0
      - TURBO_CONDITION_GUIDE=1.0
      - TURBO_END_CFG=0.4
    ports:
      - "8188:8188"
      - "8888:8888"
      - "2222:22"
    volumes:
      - ./models:/workspace/ComfyUI/models
      - ./output:/workspace/ComfyUI/output
      - /home/oz/comfyui/models/vibevoice:/workspace/ComfyUI/models/vibevoice:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

volumes:
  models:
  output:
  media-pg-data:  # PostgreSQL data volume for media_analysis database
